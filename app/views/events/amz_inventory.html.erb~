<% require 'peddler' %>
<% require 'active_support' %>
<% client_us = MWS.reports(marketplace_id: 'ATVPDKIKX0DER', merchant_id: 'A272UC6GQ1EK7B', aws_access_key_id: 'AKIAIQHK2FY7EEQKBENA', aws_secret_access_key: '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') %>
<% products = MWS.products(marketplace_id: 'ATVPDKIKX0DER', merchant_id: 'A272UC6GQ1EK7B', aws_access_key_id: 'AKIAIQHK2FY7EEQKBENA', aws_secret_access_key: '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') %>
<h1>US Numbers</h1>
<% i = 0 %>
<% client_us.request_report("_GET_AFN_INVENTORY_DATA_") %>
<% reports=Hash.from_xml(client_us.get_report_list.body) %>
<% report_id = [] %>
<% report_type = [] %>
<% reports["GetReportListResponse"]["GetReportListResult"]["ReportInfo"].each do |r| %>
		<% report_id[i] = r["ReportId"] %>
		<% report_type[i] = r["ReportType"] %>
		<% i=i+1 %>
<% end %>
<% r_id=report_id[report_type.index("_GET_AFN_INVENTORY_DATA_")] %>
<% inventory_report=client_us.get_report(r_id).body %>
<% i=0 %>
<% asin= [] %>
<% CSV.parse(inventory_report, headers: true, col_sep: "\t") do |row| %>
<% product= Hash.from_xml(products.get_matching_product(row["asin"]).body) %>
<%= row["seller-sku"] %> - 
<% if !product.blank? %>
<%= product["GetMatchingProductResponse"]["GetMatchingProductResult"]["Product"]["AttributeSets"]["ItemAttributes"]["Title"] %>
<% end %>
 - <%= row["Quantity Available"] %><br>
 
<% i=i+1 %>
<% end %>
